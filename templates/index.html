<html>
    <head>
        <title>Minimal websocket application</title>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="//code.createjs.com/createjs-2015.11.26.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone-min.js"></script>
        <script type="text/javascript">
            var app = app || {};

            app.baseSprites = {};
            app.baseImages = {};
            app.config = {{ !APP_SETTINGS }};

            var Stream = {
                init: function (app) {
                    var ws = new WebSocket("ws://" + app.config.WEBSOCKET_ADDRESS + "/game");
                    _.extend(ws, Backbone.Events);

                    ws.onmessage = function(evt) {
                        var answer = JSON.parse(evt.data);
                        var parsedData = answer.data;
                        ws.trigger(answer.msg_type, parsedData);
                    };
                    ws.onopen = function(evt) {
                        $('#conn_status').html('<b>WS Connected</b>');
                    };
                    ws.onerror = function(evt) {
                        $('#conn_status').html('<b>WS Error</b>');
                    };
                    ws.onclose = function(evt) {
                        $('#conn_status').html('<b>WS Closed</b>');
                    };
                    ws.on('render_map', function(data) {
                        app.canvas.width = data.width;
                        app.canvas.height = data.height;
                        // app.canvas.addEventListener("mousewheel", function(e) {
                        //     var zoom;
                        //     if (Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)))>0)
                        //         zoom = 1.1;
                        //     else
                        //         zoom = 1 / 1.1;
                        //         var local = app.stage.globalToLocal(app.stage.mouseX, app.stage.mouseY);
                        //     app.stage.regX = local.x;
                        //     app.stage.regY = local.y;
                        //     app.stage.x = app.stage.mouseX;
                        //     app.stage.y = app.stage.mouseY;   
                        //     app.stage.scaleX = app.stage.scaleY *= zoom;

                        //     app.stage.update();
                        // }, false);
                    });
                    ws.on('register_user', function(data) {
                        app.user = new app.UserModel(data);
                        // TODO: Maybe revert back to model??
                        app.sprites[app.user.id] = new app.SpriteView({ model: app.user });

                        app.hud = new app.HudView({ model: app.user });
                        app.weaponVision = new app.WeaponVisionView({ model: app.user });
                    });
                    ws.on('users_map', function(data) {
                        if (app.hud) app.hud.trigger('updateOnline', data.count);

                        for (var user_id in data.users.update) {
                            user_id = parseInt(user_id, 0);

                            var updateData = data.users.update[user_id];
                            updateData = (typeof updateData === 'string') ? JSON.parse(updateData) : updateData;
                            if (app.users.hasOwnProperty(user_id)) {
                                app.users[user_id].refreshData(updateData);
                            } else {
                                app.users[user_id] = new app.UserModel(updateData);
                                app.sprites[user_id] = new app.SpriteView({ model: app.users[user_id] });  
                            }
                        }
                        for (var i = 0; i < data.users.remove.length; i++) {
                            var removeId = data.users.remove[0];
                            if (app.users.hasOwnProperty(removeId)) {
                                app.sprites[removeId].destroy();
                                app.users[removeId].destroy();
                                if (app.user.id === removeId) {
                                    app.weaponVision.destroy();
                                    app.user.destroy();
                                }
                            }
                        }
                    });

                    app.ws = ws;
                }
            };
        </script>
        <script type="text/javascript">
            (function () {
                var queue, ss, s;
                
                queue = new createjs.LoadQueue(true);
                queue.setMaxConnections(20);
                queue.installPlugin(createjs.Sound);
                queue.on("fileload", onPreloadFile, this);
                // queue.on("progress", onLoadProgress, this);
                queue.on("complete", onPreloadComplete, this);
                queue.loadManifest('manifest.json');

                function onPreloadFile(evt) {
                    switch (evt.item.type) {
                        case createjs.AbstractLoader.SPRITESHEET:
                            ss = evt.result;
                            s = new createjs.Sprite(ss);

                            /* simlink */
                            s.width = ss._frameWidth;
                            s.height = ss._frameHeight;

                            app.baseSprites[evt.item.id] = s;
                            break;
                        case createjs.AbstractLoader.SOUND:
                            break;
                        case createjs.AbstractLoader.IMAGE:
                            app.baseImages[evt.item.id] = new createjs.Bitmap(evt.result);
                            break;
                    }
                }

                function onPreloadComplete(evt) {
                    Stream.init(app);
                    createjs.Sound.muted = true;
                }
                delete queue, ss, s;
            })();
        </script>
    </head>
    <body>
        <div id="conn_status">Not Connected</div>
        <div class="container">
            <canvas id="gameBoard" style="border:1px solid #d3d3d3;">Your browser does not support the HTML5 canvas tag.</canvas>
            <canvas id="gameHUD" style="border:1px solid #d3d3d3;">Your browser does not support the HTML5 canvas tag.</canvas>
        </div>

        <script type="text/javascript" src="{{ STATIC_URL }}src/helpers.js?updated={{ FILE_VERSION }}"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}src/app.js?updated={{ FILE_VERSION }}"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}src/models/users.js?updated={{ FILE_VERSION }}"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}src/views/hud.js?updated={{ FILE_VERSION }}"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}src/views/weaponVision.js?updated={{ FILE_VERSION }}"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}src/views/sprites.js?updated={{ FILE_VERSION }}"></script>
    </body>
</html>